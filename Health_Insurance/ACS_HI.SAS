
%MACRO CREATESUM;
%LET SOURCE=/DIRECTORY/;
LIBNAME ACS&YEAR. "&SOURCE.";

PROC SQL;
	CREATE TABLE SUM&YEAR. AS
	SELECT
	"20&YEAR." AS YEAR,
	CASE WHEN HINS1 = 1 THEN 1 ELSE 0 END AS ESI,
	CASE WHEN HINS2 = 1 THEN 1 ELSE 0 END AS PURCH,
	CASE WHEN HINS3 = 1 THEN 1 ELSE 0 END AS MC,
	CASE WHEN HINS4 = 1 THEN 1 ELSE 0 END AS MD,
	CASE WHEN HINS5 = 1 OR HINS6 = 1 THEN 1 ELSE 0 END AS ML,
	CASE
		WHEN AGEP IN(00:17) THEN 00
		WHEN AGEP IN(18:64) THEN 18
		WHEN AGEP IN(65:99) THEN 65
		ELSE 0 END AS AGECAT,
	CASE	WHEN HISP = 1 & RAC1P = 1 THEN 1
		WHEN HISP = 1 & RAC1P = 2 THEN 2
		WHEN HISP = 1 & RAC1P IN(6:7) THEN 3
		WHEN HISP = 1 & RAC1P IN(8:9,3:5) THEN 4
		ELSE 5 END AS RACECAT,
	CASE	WHEN POVPIP IN(.) THEN .
		WHEN POVPIP IN(  1:25 ) THEN 001
		WHEN POVPIP IN( 26:50 ) THEN 026
		WHEN POVPIP IN( 51:75 ) THEN 051
		WHEN POVPIP IN( 76:100) THEN 076
		WHEN POVPIP IN(101:133) THEN 101
		WHEN POVPIP IN(134:150) THEN 134
		WHEN POVPIP IN(151:175) THEN 151
		WHEN POVPIP IN(176:200) THEN 176
		WHEN POVPIP IN(201:225) THEN 201
		WHEN POVPIP IN(226:250) THEN 226
		WHEN POVPIP IN(251:275) THEN 251
		WHEN POVPIP IN(276:300) THEN 276
		WHEN POVPIP IN(301:325) THEN 301
		WHEN POVPIP IN(326:350) THEN 326
		WHEN POVPIP IN(351:375) THEN 351
		WHEN POVPIP IN(376:400) THEN 376
		WHEN POVPIP IN(401:425) THEN 401
		WHEN POVPIP IN(426:450) THEN 426
		WHEN POVPIP IN(451:475) THEN 451
		WHEN POVPIP IN(476:500) THEN 476
		ELSE 501 END AS POVCAT,
	SUM(PWGTP) AS POP
	FROM ACS&YEAR..P
	GROUP BY CALCULATED ESI, CALCULATED PURCH, CALCULATED MC, CALCULATED MD, CALCULATED ML,
		CALCULATED RACECAT, CALCULATED AGECAT, CALCULATED POVCAT;
QUIT;
%MEND;

%LET YEAR=08; %CREATESUM
%LET YEAR=09; %CREATESUM
%LET YEAR=10; %CREATESUM
%LET YEAR=11; %CREATESUM
%LET YEAR=12; %CREATESUM
%LET YEAR=13; %CREATESUM
%LET YEAR=14; %CREATESUM
%LET YEAR=15; %CREATESUM

%LET ACS=/DIRECTORY2/;
LIBNAME ACS "&ACS.";

DATA ENROLLMENT;
	SET SUM:;
	IF SUM(OF ESI, PURCH, MC, MD, ML) = 0 THEN AGEINS = 0;
		ELSE IF ESI AND SUM(OF PURCH, MC, MD, ML) = 0 THEN AGEINS = 1;
		ELSE IF (ESI OR PURCH) AND SUM(OF MC, MD, ML) = 0 THEN AGEINS = 2;
		ELSE IF (ESI OR PURCH) AND (MC OR MD OR ML) THEN AGEINS = 3;
		ELSE IF MD AND SUM(OF ESI, PURCH, MC, ML) = 0 THEN AGEINS = 4;
		ELSE IF MC AND SUM(OF ESI, PURCH, MD, ML) = 0 THEN AGEINS = 5;
		ELSE IF (MC OR MD OR ML) AND SUM(OF ESI, PURCH) = 0 THEN AGEINS = 6;

	IF AGEINS = 0 THEN POVINS = 0;
	IF AGEINS = 1 THEN POVINS = 1;
	IF AGEINS = 2 THEN POVINS = 2;
	IF AGEINS = 3 THEN POVINS = 3;
	IF AGEINS = 4 THEN POVINS = 4;
	IF AGEINS IN(5,6) THEN POVINS = 5;

RUN;

PROC SUMMARY DATA=ENROLLMENT NWAY MISSING;
	VAR POP;
	CLASS YEAR AGECAT POVCAT AGEINS;
	OUTPUT OUT=ACS.POVENROLL(DROP=_type_ _freq_) SUM=POP;
QUIT;

DATA ACS.FPL;
	INPUT YEAR $4. BASE PLUS;
CARDS;
2008 10400 3600
2009 10830 3740
2010 10830 3740
2011 10890 3820
2012 11170 3960
2013 11490 4020
2014 11670 4060
2015 11770 4160
;
RUN;

DATA ACS.AGEINS;
	INFILE "&ACS.AGEINS.TXT" TRUNCOVER;
	INPUT 
	@1 AGEINS 1.
	@3 AGEINSLAB $30.;
RUN;

DATA _NULL_;
	SET ACS.AGEINS;
	FILE "&ACS.AGEINS.CSV" DSD DLM="," NOTITLES;
	IF _n_ = 1 THEN PUT "AGEINS,AGEINSLAB";
	PUT AGEINS AGEINSLAB;
RUN;

DATA ACS.AGECAT;
	INFILE "&ACS.AGECAT.TXT" TRUNCOVER;
	INPUT 
	@1 AGECAT 2.
	@4 AGECATLAB $30.;
RUN;

DATA _NULL_;
	SET ACS.AGECAT;
	FILE "&ACS.AGECAT.CSV" DSD DLM="," NOTITLES;
	IF _n_ = 1 THEN PUT "AGECAT,AGECATLAB";
	PUT AGECAT AGECATLAB;
RUN;

DATA ACS.POVCAT;
	INFILE "&ACS.POVCAT.TXT" TRUNCOVER;
	INPUT 
	@1 POVCAT 3.
	@5 POVCATLAB $30.;
RUN;

DATA _NULL_;
	SET ACS.POVCAT;
	FILE "&ACS.POVCAT.CSV" DSD DLM="," NOTITLES;
	IF _n_ = 1 THEN PUT "POVCAT,POVCATLAB";
	PUT POVCAT POVCATLAB;
RUN;

DATA _NULL_;
	SET ACS.POVENROLL;
	FILE "&ACS.POVENROLL.CSV" DSD DLM="," NOTITLES;
	IF _n_ = 1 THEN PUT "YEAR,AGECAT,POVCAT,AGEINS,POP";
	PUT YEAR AGECAT POVCAT AGEINS POP;
RUN;
